name: go-nomads

services:
  # ============================================================
  # Dapr Placement Service (Required for Actors)
  # ============================================================
  dapr-placement:
    image: daprio/dapr:1.14.4
    container_name: go-nomads-dapr-placement
    command: ["./placement", "-port", "50006"]
    ports:
      - "50006:50006"
    networks:
      - go-nomads-network

  # ============================================================
  # API Gateway
  # ============================================================
  gateway:
    build:
      context: .
      dockerfile: src/Gateway/Gateway/Dockerfile
    container_name: go-nomads-gateway
    ports:
      - "5080:5000"
      - "3500:3500"
    depends_on:
      - user-service
      - city-service
      - coworking-service
      - accommodation-service
      - event-service
      - dapr-placement
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5000
      - DAPR_HTTP_PORT=3500
      - DAPR_GRPC_PORT=50001
      - Consul__Address=http://go-nomads-consul:7500
      - Consul__ServiceAddress=go-nomads-gateway
      - Consul__ServicePort=5000
    networks:
      - go-nomads-network

  gateway-dapr:
    image: daprio/daprd:1.14.4
    container_name: go-nomads-gateway-dapr
    command: ["./daprd",
      "--app-id", "gateway",
      "--app-port", "5000",
      "--dapr-http-port", "3500",
      "--dapr-grpc-port", "50001",
      "--placement-host-address", "go-nomads-dapr-placement:50006",
      "--components-path", "/components",
      "--log-level", "info"
    ]
    volumes:
      - ./deployment/dapr/components:/components
    network_mode: "service:gateway"
    depends_on:
      - gateway

  # ============================================================
  # Document Service
  # ============================================================
  document-service:
    build:
      context: .
      dockerfile: src/Services/DocumentService/DocumentService/Dockerfile
    container_name: go-nomads-document-service
    ports:
      - "5003:8080"
      - "3503:3503"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - DAPR_HTTP_PORT=3503
      - DAPR_GRPC_PORT=50001
      - Consul__Address=http://go-nomads-consul:7500
      - Consul__ServiceAddress=go-nomads-document-service
      - Consul__ServicePort=8080
      - Services__Gateway__Url=http://go-nomads-gateway:8080
      - Services__Gateway__OpenApiUrl=http://go-nomads-gateway:8080/openapi/v1.json
      - Services__ProductService__Url=http://go-nomads-product-service:8080
      - Services__ProductService__OpenApiUrl=http://go-nomads-product-service:8080/openapi/v1.json
      - Services__UserService__Url=http://go-nomads-user-service:8080
      - Services__UserService__OpenApiUrl=http://go-nomads-user-service:8080/openapi/v1.json
    networks:
      - go-nomads-network
    depends_on:
      - dapr-placement

  document-service-dapr:
    image: daprio/daprd:1.14.4
    container_name: go-nomads-document-service-dapr
    command: ["./daprd",
      "--app-id", "document-service",
      "--app-port", "8080",
      "--dapr-http-port", "3503",
      "--dapr-grpc-port", "50001",
      "--placement-host-address", "go-nomads-dapr-placement:50006",
      "--components-path", "/components",
      "--log-level", "info"
    ]
    volumes:
      - ./deployment/dapr/components:/components
    network_mode: "service:document-service"
    depends_on:
      - document-service

  # ============================================================
  # User Service
  # ============================================================
  user-service:
    build:
      context: .
      dockerfile: src/Services/UserService/UserService/Dockerfile
    container_name: go-nomads-user-service
    ports:
      - "5001:8080"
      - "50002:50002"
      - "3502:3502"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - DAPR_HTTP_PORT=3502
      - DAPR_GRPC_PORT=50001
      - Consul__Address=http://go-nomads-consul:7500
      - Consul__ServiceAddress=go-nomads-user-service
      - Consul__ServicePort=8080
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=userservice_db;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=go-nomads-redis:6379
    networks:
      - go-nomads-network
    depends_on:
      - dapr-placement

  user-service-dapr:
    image: daprio/daprd:1.14.4
    container_name: go-nomads-user-service-dapr
    command: ["./daprd",
      "--app-id", "user-service",
      "--app-port", "8080",
      "--dapr-http-port", "3502",
      "--dapr-grpc-port", "50001",
      "--placement-host-address", "go-nomads-dapr-placement:50006",
      "--components-path", "/components",
      "--log-level", "info"
    ]
    volumes:
      - ./deployment/dapr/components:/components
    network_mode: "service:user-service"
    depends_on:
      - user-service

  # ============================================================
  # City Service
  # ============================================================
  city-service:
    build:
      context: .
      dockerfile: src/Services/CityService/CityService/Dockerfile
    container_name: go-nomads-city-service
    ports:
      - "8002:8002"
      - "3504:3504"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8002
      - DAPR_HTTP_PORT=3504
      - DAPR_GRPC_PORT=50001
      - Consul__Address=http://go-nomads-consul:7500
      - Consul__ServiceAddress=go-nomads-city-service
      - Consul__ServicePort=8002
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=cityservice_db;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=go-nomads-redis:6379
      - ConnectionStrings__Elasticsearch=http://go-nomads-elasticsearch:9200
      - RabbitMQ__Host=go-nomads-rabbitmq
      - RabbitMQ__Username=guest
      - RabbitMQ__Password=guest
    networks:
      - go-nomads-network
    depends_on:
      - dapr-placement

  city-service-dapr:
    image: daprio/daprd:1.14.4
    container_name: go-nomads-city-service-dapr
    command: ["./daprd",
      "--app-id", "city-service",
      "--app-port", "8002",
      "--dapr-http-port", "3504",
      "--dapr-grpc-port", "50001",
      "--placement-host-address", "go-nomads-dapr-placement:50006",
      "--components-path", "/components",
      "--log-level", "info"
    ]
    volumes:
      - ./deployment/dapr/components:/components
    network_mode: "service:city-service"
    depends_on:
      - city-service

  # ============================================================
  # Coworking Service
  # ============================================================
  coworking-service:
    build:
      context: .
      dockerfile: src/Services/CoworkingService/CoworkingService/Dockerfile
    container_name: go-nomads-coworking-service
    ports:
      - "8006:8006"
      - "3506:3506"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8006
      - DAPR_HTTP_PORT=3506
      - DAPR_GRPC_PORT=50001
      - Consul__Address=http://go-nomads-consul:7500
      - Consul__ServiceAddress=go-nomads-coworking-service
      - Consul__ServicePort=8006
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=coworkingservice_db;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=go-nomads-redis:6379
    networks:
      - go-nomads-network
    depends_on:
      - dapr-placement

  coworking-service-dapr:
    image: daprio/daprd:1.14.4
    container_name: go-nomads-coworking-service-dapr
    command: ["./daprd",
      "--app-id", "coworking-service",
      "--app-port", "8006",
      "--dapr-http-port", "3506",
      "--dapr-grpc-port", "50001",
      "--placement-host-address", "go-nomads-dapr-placement:50006",
      "--components-path", "/components",
      "--log-level", "info"
    ]
    volumes:
      - ./deployment/dapr/components:/components
    network_mode: "service:coworking-service"
    depends_on:
      - coworking-service

  # ============================================================
  # Search Service
  # ============================================================
  search-service:
    build:
      context: .
      dockerfile: src/Services/SearchService/SearchService/Dockerfile
    container_name: go-nomads-search-service
    ports:
      - "8015:8080"
      - "3515:3515"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - DAPR_HTTP_PORT=3515
      - DAPR_GRPC_PORT=50001
      - Consul__Address=http://go-nomads-consul:7500
      - Consul__ServiceAddress=go-nomads-search-service
      - Consul__ServicePort=8080
      - Elasticsearch__Url=http://go-nomads-elasticsearch:9200
      - ServiceUrls__CityService=http://go-nomads-city-service:8002
      - ServiceUrls__CoworkingService=http://go-nomads-coworking-service:8006
      - RabbitMQ__Host=go-nomads-rabbitmq
      - RabbitMQ__Username=guest
      - RabbitMQ__Password=guest
    networks:
      - go-nomads-network
    depends_on:
      - dapr-placement
      - city-service
      - coworking-service

  search-service-dapr:
    image: daprio/daprd:1.14.4
    container_name: go-nomads-search-service-dapr
    command: ["./daprd",
      "--app-id", "search-service",
      "--app-port", "8080",
      "--dapr-http-port", "3515",
      "--dapr-grpc-port", "50001",
      "--placement-host-address", "go-nomads-dapr-placement:50006",
      "--components-path", "/components",
      "--log-level", "info"
    ]
    volumes:
      - ./deployment/dapr/components:/components
    network_mode: "service:search-service"
    depends_on:
      - search-service

  # ============================================================
  # Cache Service
  # ============================================================
  cache-service:
    build:
      context: .
      dockerfile: src/Services/CacheService/CacheService/Dockerfile
    container_name: go-nomads-cache-service
    ports:
      - "8010:8010"
      - "3512:3512"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8010
      - DAPR_HTTP_PORT=3512
      - DAPR_GRPC_PORT=50001
      - Consul__Address=http://go-nomads-consul:7500
      - Consul__ServiceAddress=go-nomads-cache-service
      - Consul__ServicePort=8010
      - ConnectionStrings__Redis=go-nomads-redis:6379
    networks:
      - go-nomads-network
    depends_on:
      - dapr-placement

  cache-service-dapr:
    image: daprio/daprd:1.14.4
    container_name: go-nomads-cache-service-dapr
    command: ["./daprd",
      "--app-id", "cache-service",
      "--app-port", "8010",
      "--dapr-http-port", "3512",
      "--dapr-grpc-port", "50001",
      "--placement-host-address", "go-nomads-dapr-placement:50006",
      "--components-path", "/components",
      "--log-level", "info"
    ]
    volumes:
      - ./deployment/dapr/components:/components
    network_mode: "service:cache-service"
    depends_on:
      - cache-service

  # ============================================================
  # Accommodation Service
  # ============================================================
  accommodation-service:
    build:
      context: .
      dockerfile: src/Services/AccommodationService/AccommodationService/Dockerfile
    container_name: go-nomads-accommodation-service
    ports:
      - "8012:8012"
      - "3513:3513"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8012
      - DAPR_HTTP_PORT=3513
      - DAPR_GRPC_PORT=50001
      - Consul__Address=http://go-nomads-consul:7500
      - Consul__ServiceAddress=go-nomads-accommodation-service
      - Consul__ServicePort=8012
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=accommodationservice_db;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=go-nomads-redis:6379
    networks:
      - go-nomads-network
    depends_on:
      - dapr-placement

  accommodation-service-dapr:
    image: daprio/daprd:1.14.4
    container_name: go-nomads-accommodation-service-dapr
    command: ["./daprd",
      "--app-id", "accommodation-service",
      "--app-port", "8012",
      "--dapr-http-port", "3513",
      "--dapr-grpc-port", "50001",
      "--placement-host-address", "go-nomads-dapr-placement:50006",
      "--components-path", "/components",
      "--log-level", "info"
    ]
    volumes:
      - ./deployment/dapr/components:/components
    network_mode: "service:accommodation-service"
    depends_on:
      - accommodation-service

  # ============================================================
  # Event Service
  # ============================================================
  event-service:
    build:
      context: .
      dockerfile: src/Services/EventService/EventService/Dockerfile
    container_name: go-nomads-event-service
    ports:
      - "8005:8005"
      - "3505:3505"
    environment:
      - TZ=Asia/Shanghai
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8005
      - DAPR_HTTP_PORT=3505
      - DAPR_GRPC_PORT=50001
      - Consul__Address=http://go-nomads-consul:7500
      - Consul__ServiceAddress=go-nomads-event-service
      - Consul__ServicePort=8005
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=eventservice_db;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=go-nomads-redis:6379
      - MessageBroker__Host=go-nomads-rabbitmq
    networks:
      - go-nomads-network
    depends_on:
      - dapr-placement

  event-service-dapr:
    image: daprio/daprd:1.14.4
    container_name: go-nomads-event-service-dapr
    command: ["./daprd",
      "--app-id", "event-service",
      "--app-port", "8005",
      "--dapr-http-port", "3505",
      "--dapr-grpc-port", "50001",
      "--placement-host-address", "go-nomads-dapr-placement:50006",
      "--components-path", "/components",
      "--log-level", "info"
    ]
    volumes:
      - ./deployment/dapr/components:/components
    network_mode: "service:event-service"
    depends_on:
      - event-service

  # ============================================================
  # Product Service
  # ============================================================
  product-service:
    build:
      context: .
      dockerfile: src/Services/ProductService/ProductService/Dockerfile
    container_name: go-nomads-product-service
    ports:
      - "5002:5002"
      - "3501:3501"
    depends_on:
      - user-service
      - dapr-placement
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5002
      - DAPR_HTTP_PORT=3501
      - DAPR_GRPC_PORT=50001
      - Consul__Address=http://go-nomads-consul:7500
      - Consul__ServiceAddress=go-nomads-product-service
      - Consul__ServicePort=5002
    networks:
      - go-nomads-network

  product-service-dapr:
    image: daprio/daprd:1.14.4
    container_name: go-nomads-product-service-dapr
    command: ["./daprd",
      "--app-id", "product-service",
      "--app-port", "5002",
      "--dapr-http-port", "3501",
      "--dapr-grpc-port", "50001",
      "--placement-host-address", "go-nomads-dapr-placement:50006",
      "--components-path", "/components",
      "--log-level", "info"
    ]
    volumes:
      - ./deployment/dapr/components:/components
    network_mode: "service:product-service"
    depends_on:
      - product-service

  # ============================================================
  # AI Service
  # ============================================================
  ai-service:
    build:
      context: .
      dockerfile: src/Services/AIService/AIService/Dockerfile
    container_name: go-nomads-ai-service
    ports:
      - "8009:8009"
      - "3509:3509"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8009
      - DAPR_HTTP_PORT=3509
      - DAPR_GRPC_PORT=50001
      - ConnectionStrings__SupabaseDb=Host=postgres;Port=5432;Database=aiservice_db;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=go-nomads-redis:6379
      - ConnectionStrings__QianWenApiKey=${QIANWEN_API_KEY:-your-qianwen-api-key-here}
      - Consul__Address=http://go-nomads-consul:7500
      - Consul__ServiceAddress=go-nomads-ai-service
      - Consul__ServicePort=8009
      - RabbitMQ__HostName=go-nomads-rabbitmq
      - Redis__ConnectionString=go-nomads-redis:6379,abortConnect=false
      - Dapr__GrpcPort=50001
      - Dapr__HttpPort=3509
    networks:
      - go-nomads-network
    labels:
      - "prometheus.scrape=true"
      - "prometheus.port=8009"
      - "prometheus.path=/metrics"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8009/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - dapr-placement

  ai-service-dapr:
    image: daprio/daprd:1.14.4
    container_name: go-nomads-ai-service-dapr
    command: ["./daprd",
      "--app-id", "ai-service",
      "--app-port", "8009",
      "--dapr-http-port", "3509",
      "--dapr-grpc-port", "50001",
      "--placement-host-address", "go-nomads-dapr-placement:50006",
      "--components-path", "/components",
      "--log-level", "info"
    ]
    volumes:
      - ./deployment/dapr/components:/components
    network_mode: "service:ai-service"
    depends_on:
      - ai-service

  # ============================================================
  # Message Service (SignalR Hubs)
  # ============================================================
  message-service:
    build:
      context: .
      dockerfile: src/Services/MessageService/MessageService/API/Dockerfile
    container_name: go-nomads-message-service
    ports:
      - "5005:8080"
      - "3511:3511"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - DAPR_HTTP_PORT=3511
      - DAPR_GRPC_PORT=50001
      - Consul__Address=http://go-nomads-consul:7500
      - Consul__ServiceAddress=go-nomads-message-service
      - Consul__ServicePort=8080
      - ConnectionStrings__Redis=go-nomads-redis:6379
      - RabbitMQ__HostName=go-nomads-rabbitmq
      - RabbitMQ__Port=5672
      - RabbitMQ__UserName=guest
      - RabbitMQ__Password=guest
    networks:
      - go-nomads-network
    depends_on:
      - dapr-placement

  message-service-dapr:
    image: daprio/daprd:1.14.4
    container_name: go-nomads-message-service-dapr
    command: ["./daprd",
      "--app-id", "message-service",
      "--app-port", "8080",
      "--dapr-http-port", "3511",
      "--dapr-grpc-port", "50001",
      "--placement-host-address", "go-nomads-dapr-placement:50006",
      "--components-path", "/components",
      "--log-level", "info"
    ]
    volumes:
      - ./deployment/dapr/components:/components
    network_mode: "service:message-service"
    depends_on:
      - message-service

  # ============================================================
  # Innovation Service
  # ============================================================
  innovation-service:
    build:
      context: .
      dockerfile: src/Services/InnovationService/InnovationService/Dockerfile
    container_name: go-nomads-innovation-service
    ports:
      - "8011:8011"
      - "3514:3514"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8011
      - DAPR_HTTP_PORT=3514
      - DAPR_GRPC_PORT=50001
      - Consul__Address=http://go-nomads-consul:7500
      - Consul__ServiceAddress=go-nomads-innovation-service
      - Consul__ServicePort=8011
    networks:
      - go-nomads-network
    depends_on:
      - dapr-placement

  innovation-service-dapr:
    image: daprio/daprd:1.14.4
    container_name: go-nomads-innovation-service-dapr
    command: ["./daprd",
      "--app-id", "innovation-service",
      "--app-port", "8011",
      "--dapr-http-port", "3514",
      "--dapr-grpc-port", "50001",
      "--placement-host-address", "go-nomads-dapr-placement:50006",
      "--components-path", "/components",
      "--log-level", "info"
    ]
    volumes:
      - ./deployment/dapr/components:/components
    network_mode: "service:innovation-service"
    depends_on:
      - innovation-service

  # ============================================================
  # Travel Planning Service (No Dapr needed)
  # ============================================================
  travel-planning-service:
    build:
      context: .
      dockerfile: src/Services/TravelPlanningService/TravelPlanningService/Dockerfile
    container_name: go-nomads-travel-planning-service
    ports:
      - "8007:8007"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8007
      - Consul__Address=http://go-nomads-consul:7500
      - Consul__ServiceAddress=go-nomads-travel-planning-service
      - Consul__ServicePort=8007
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=travelplanningservice_db;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=go-nomads-redis:6379
      - OpenAI__ApiKey=${OPENAI_API_KEY}
    networks:
      - go-nomads-network

  # ============================================================
  # Ecommerce Service (No Dapr needed)
  # ============================================================
  ecommerce-service:
    build:
      context: .
      dockerfile: src/Services/EcommerceService/EcommerceService/Dockerfile
    container_name: go-nomads-ecommerce-service
    ports:
      - "8008:8008"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8008
      - Consul__Address=http://go-nomads-consul:7500
      - Consul__ServiceAddress=go-nomads-ecommerce-service
      - Consul__ServicePort=8008
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=ecommerceservice_db;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=go-nomads-redis:6379
    networks:
      - go-nomads-network

networks:
  go-nomads-network:
    external: true
