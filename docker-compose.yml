name: go-nomads

services:
  # API Gateway
  gateway:
    build:
      context: .
      dockerfile: src/Gateway/Gateway/Dockerfile
    container_name: go-nomads-gateway
    ports:
      - "5000:80"
    depends_on:
      - user-service
      - city-service
      - coworking-service
      - accommodation-service
      - event-service
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
    networks:
      - go-nomads-infras_gonomads-network

  # Core Business Services
  user-service:
    build:
      context: .
      dockerfile: src/Services/UserService/UserService/Dockerfile
    container_name: go-nomads-user-service
    ports:
      - "8001:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=userservice_db;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=go-nomads-redis:6379
    networks:
      - go-nomads-infras_gonomads-network

  city-service:
    build:
      context: .
      dockerfile: src/Services/CityService/CityService/Dockerfile
    container_name: go-nomads-city-service
    ports:
      - "8002:8002"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8002
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=cityservice_db;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=go-nomads-redis:6379
      - ConnectionStrings__Elasticsearch=http://go-nomads-elasticsearch:9200
      - RabbitMQ__Host=go-nomads-rabbitmq
      - RabbitMQ__Username=guest
      - RabbitMQ__Password=guest
    networks:
      - go-nomads-infras_gonomads-network

  coworking-service:
    build:
      context: .
      dockerfile: src/Services/CoworkingService/CoworkingService/Dockerfile
    container_name: go-nomads-coworking-service
    ports:
      - "8003:8003"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8003
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=coworkingservice_db;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=go-nomads-redis:6379
    networks:
      - go-nomads-infras_gonomads-network

  accommodation-service:
    build:
      context: .
      dockerfile: src/Services/AccommodationService/AccommodationService/Dockerfile
    container_name: go-nomads-accommodation-service
    ports:
      - "8004:8004"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8004
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=accommodationservice_db;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=go-nomads-redis:6379
    networks:
      - go-nomads-infras_gonomads-network

  event-service:
    build:
      context: .
      dockerfile: src/Services/EventService/EventService/Dockerfile
    container_name: go-nomads-event-service
    ports:
      - "8005:8005"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8005
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=eventservice_db;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=go-nomads-redis:6379
      - MessageBroker__Host=go-nomads-rabbitmq
    networks:
      - go-nomads-infras_gonomads-network

  innovation-service:
    build:
      context: .
      dockerfile: src/Services/InnovationService/InnovationService/Dockerfile
    container_name: go-nomads-innovation-service
    ports:
      - "8006:8006"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8006
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=innovationservice_db;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=go-nomads-redis:6379
    networks:
      - go-nomads-infras_gonomads-network

  travel-planning-service:
    build:
      context: .
      dockerfile: src/Services/TravelPlanningService/TravelPlanningService/Dockerfile
    container_name: go-nomads-travel-planning-service
    ports:
      - "8007:8007"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8007
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=travelplanningservice_db;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=go-nomads-redis:6379
      - OpenAI__ApiKey=${OPENAI_API_KEY}
    networks:
      - go-nomads-infras_gonomads-network

  ecommerce-service:
    build:
      context: .
      dockerfile: src/Services/EcommerceService/EcommerceService/Dockerfile
    container_name: go-nomads-ecommerce-service
    ports:
      - "8008:8008"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8008
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=ecommerceservice_db;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=go-nomads-redis:6379
    networks:
      - go-nomads-infras_gonomads-network

  product-service:
    build:
      context: .
      dockerfile: src/Services/ProductService/ProductService/Dockerfile
    container_name: go-nomads-product-service
    ports:
      - "5002:80"
    depends_on:
      - user-service
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
    networks:
      - go-nomads-infras_gonomads-network

  ai-service:
    build:
      context: .
      dockerfile: src/Services/AIService/AIService/Dockerfile
    container_name: go-nomads-ai-service
    ports:
      - "8009:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__SupabaseDb=Host=postgres;Port=5432;Database=aiservice_db;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=go-nomads-redis:6379
      - ConnectionStrings__QianWenApiKey=${QIANWEN_API_KEY:-your-qianwen-api-key-here}
      - Consul__Address=http://go-nomads-consul:8500
      - Consul__ServiceAddress=ai-service
      - Consul__ServicePort=8080
      - RabbitMQ__HostName=go-nomads-rabbitmq
      - Redis__ConnectionString=go-nomads-redis:6379,abortConnect=false
      - Dapr__GrpcPort=50001
      - Dapr__HttpPort=3509
    networks:
      - go-nomads-infras_gonomads-network
    labels:
      - "prometheus.scrape=true"
      - "prometheus.port=8080"
      - "prometheus.path=/metrics"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  go-nomads-infras_gonomads-network:
    external: true
