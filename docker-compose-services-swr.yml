name: go-nomads

# ============================================================
# Go-Nomads 后端服务 - 从华为云 SWR 拉取预构建镜像
# (Aspire 架构: ServiceDiscovery + OTLP, 无 Dapr/Consul)
#
# 使用方法:
#   启动: docker compose -f docker-compose-services-swr.yml up -d
#   停止: docker compose -f docker-compose-services-swr.yml down
#   更新: docker compose -f docker-compose-services-swr.yml pull && \
#          docker compose -f docker-compose-services-swr.yml up -d
#   日志: docker compose -f docker-compose-services-swr.yml logs -f [service]
# ============================================================

x-swr-registry: &swr-registry "swr.ap-southeast-3.myhuaweicloud.com/go-nomads"

# 通用环境变量锚点
x-common-env: &common-env
  ASPNETCORE_ENVIRONMENT: Production
  # Aspire Dashboard OTLP (可选, 如未部署 dashboard 则自动跳过)
  OTEL_EXPORTER_OTLP_ENDPOINT: "http://go-nomads-aspire-dashboard:18889"

x-infra-env: &infra-env
  # Redis
  REDIS_HOST: &redis-host "go-nomads-redis"
  REDIS_PORT: &redis-port "6379"
  # RabbitMQ
  RABBITMQ_HOST: &rabbitmq-host "go-nomads-rabbitmq"
  RABBITMQ_USER: &rabbitmq-user "walden"
  RABBITMQ_PASS: &rabbitmq-pass "walden"
  # Elasticsearch
  ELASTICSEARCH_URL: &elasticsearch-url "http://go-nomads-elasticsearch:9200"

# 服务发现辅助: Aspire ServiceDiscovery 格式 services__{name}__http__0
# 所有服务容器内监听 8080, Gateway 监听 5000
x-svc-gateway:          &svc-gateway          "http://go-nomads-gateway:5000"
x-svc-user:             &svc-user             "http://go-nomads-user-service:8080"
x-svc-city:             &svc-city             "http://go-nomads-city-service:8080"
x-svc-product:          &svc-product          "http://go-nomads-product-service:8080"
x-svc-document:         &svc-document         "http://go-nomads-document-service:8080"
x-svc-coworking:        &svc-coworking        "http://go-nomads-coworking-service:8080"
x-svc-accommodation:    &svc-accommodation    "http://go-nomads-accommodation-service:8080"
x-svc-event:            &svc-event            "http://go-nomads-event-service:8080"
x-svc-innovation:       &svc-innovation       "http://go-nomads-innovation-service:8080"
x-svc-ai:               &svc-ai              "http://go-nomads-ai-service:8080"
x-svc-search:           &svc-search           "http://go-nomads-search-service:8080"
x-svc-cache:            &svc-cache            "http://go-nomads-cache-service:8080"
x-svc-message:          &svc-message          "http://go-nomads-message-service:8080"

services:
  # ============================================================
  # API Gateway (YARP)
  # ============================================================
  gateway:
    image: swr.ap-southeast-3.myhuaweicloud.com/go-nomads/gateway:latest
    container_name: go-nomads-gateway
    ports:
      - "5080:5000"
    environment:
      <<: *common-env
      ASPNETCORE_URLS: "http://+:5000"
      OTEL_SERVICE_NAME: gateway
      # 服务发现 - Gateway 需要所有后端服务地址
      services__user-service__http__0:          *svc-user
      services__city-service__http__0:          *svc-city
      services__product-service__http__0:       *svc-product
      services__document-service__http__0:      *svc-document
      services__coworking-service__http__0:     *svc-coworking
      services__accommodation-service__http__0: *svc-accommodation
      services__event-service__http__0:         *svc-event
      services__innovation-service__http__0:    *svc-innovation
      services__ai-service__http__0:            *svc-ai
      services__search-service__http__0:        *svc-search
      services__cache-service__http__0:         *svc-cache
      services__message-service__http__0:       *svc-message
    networks:
      - go-nomads-network
    depends_on:
      - user-service
      - city-service
    restart: unless-stopped

  # ============================================================
  # User Service
  # ============================================================
  user-service:
    image: swr.ap-southeast-3.myhuaweicloud.com/go-nomads/user-service:latest
    container_name: go-nomads-user-service
    ports:
      - "5001:8080"
    environment:
      <<: *common-env
      ASPNETCORE_URLS: "http://+:8080"
      OTEL_SERVICE_NAME: user-service
      ConnectionStrings__redis: "go-nomads-redis:6379"
      RabbitMQ__Host: *rabbitmq-host
      RabbitMQ__Username: *rabbitmq-user
      RabbitMQ__Password: *rabbitmq-pass
      # 阿里云短信 - 通过 .env 文件注入
      AliyunSms__AccessKeyId: "${ALIYUN_SMS_ACCESS_KEY_ID}"
      AliyunSms__AccessKeySecret: "${ALIYUN_SMS_ACCESS_KEY_SECRET}"
      # 服务发现
      services__city-service__http__0:    *svc-city
      services__product-service__http__0: *svc-product
      services__event-service__http__0:   *svc-event
    networks:
      - go-nomads-network
    restart: unless-stopped

  # ============================================================
  # City Service
  # ============================================================
  city-service:
    image: swr.ap-southeast-3.myhuaweicloud.com/go-nomads/city-service:latest
    container_name: go-nomads-city-service
    ports:
      - "8002:8080"
    environment:
      <<: *common-env
      ASPNETCORE_URLS: "http://+:8080"
      OTEL_SERVICE_NAME: city-service
      RabbitMQ__Host: *rabbitmq-host
      RabbitMQ__Username: *rabbitmq-user
      RabbitMQ__Password: *rabbitmq-pass
      # 服务发现
      services__user-service__http__0:      *svc-user
      services__cache-service__http__0:     *svc-cache
      services__coworking-service__http__0: *svc-coworking
      services__event-service__http__0:     *svc-event
      services__message-service__http__0:   *svc-message
      services__ai-service__http__0:        *svc-ai
    networks:
      - go-nomads-network
    restart: unless-stopped

  # ============================================================
  # Product Service
  # ============================================================
  product-service:
    image: swr.ap-southeast-3.myhuaweicloud.com/go-nomads/product-service:latest
    container_name: go-nomads-product-service
    ports:
      - "5002:8080"
    environment:
      <<: *common-env
      ASPNETCORE_URLS: "http://+:8080"
      OTEL_SERVICE_NAME: product-service
      services__user-service__http__0: *svc-user
    networks:
      - go-nomads-network
    restart: unless-stopped

  # ============================================================
  # Document Service
  # ============================================================
  document-service:
    image: swr.ap-southeast-3.myhuaweicloud.com/go-nomads/document-service:latest
    container_name: go-nomads-document-service
    ports:
      - "5003:8080"
    environment:
      <<: *common-env
      ASPNETCORE_URLS: "http://+:8080"
      OTEL_SERVICE_NAME: document-service
      Services__Gateway__Url: "http://go-nomads-gateway:5000"
      Services__Gateway__OpenApiUrl: "http://go-nomads-gateway:5000/openapi/v1.json"
      Services__ProductService__Url: *svc-product
      Services__ProductService__OpenApiUrl: "http://go-nomads-product-service:8080/openapi/v1.json"
      Services__UserService__Url: *svc-user
      Services__UserService__OpenApiUrl: "http://go-nomads-user-service:8080/openapi/v1.json"
      services__product-service__http__0: *svc-product
    networks:
      - go-nomads-network
    restart: unless-stopped

  # ============================================================
  # Coworking Service
  # ============================================================
  coworking-service:
    image: swr.ap-southeast-3.myhuaweicloud.com/go-nomads/coworking-service:latest
    container_name: go-nomads-coworking-service
    ports:
      - "8006:8080"
    environment:
      <<: *common-env
      ASPNETCORE_URLS: "http://+:8080"
      OTEL_SERVICE_NAME: coworking-service
      RabbitMQ__Host: *rabbitmq-host
      RabbitMQ__Username: *rabbitmq-user
      RabbitMQ__Password: *rabbitmq-pass
      services__cache-service__http__0: *svc-cache
      services__user-service__http__0:  *svc-user
      services__city-service__http__0:  *svc-city
    networks:
      - go-nomads-network
    restart: unless-stopped

  # ============================================================
  # Event Service
  # ============================================================
  event-service:
    image: swr.ap-southeast-3.myhuaweicloud.com/go-nomads/event-service:latest
    container_name: go-nomads-event-service
    ports:
      - "8005:8080"
    environment:
      <<: *common-env
      ASPNETCORE_URLS: "http://+:8080"
      OTEL_SERVICE_NAME: event-service
      RabbitMQ__Host: *rabbitmq-host
      RabbitMQ__Username: *rabbitmq-user
      RabbitMQ__Password: *rabbitmq-pass
      services__city-service__http__0:    *svc-city
      services__user-service__http__0:    *svc-user
      services__message-service__http__0: *svc-message
    networks:
      - go-nomads-network
    restart: unless-stopped

  # ============================================================
  # AI Service
  # ============================================================
  ai-service:
    image: swr.ap-southeast-3.myhuaweicloud.com/go-nomads/ai-service:latest
    container_name: go-nomads-ai-service
    ports:
      - "8009:8080"
    environment:
      <<: *common-env
      ASPNETCORE_URLS: "http://+:8080"
      OTEL_SERVICE_NAME: ai-service
      Redis__ConnectionString: "go-nomads-redis:6379"
      RabbitMQ__HostName: *rabbitmq-host
      RabbitMQ__UserName: *rabbitmq-user
      RabbitMQ__Password: *rabbitmq-pass
      services__user-service__http__0: *svc-user
      services__city-service__http__0: *svc-city
    networks:
      - go-nomads-network
    restart: unless-stopped

  # ============================================================
  # Cache Service
  # ============================================================
  cache-service:
    image: swr.ap-southeast-3.myhuaweicloud.com/go-nomads/cache-service:latest
    container_name: go-nomads-cache-service
    ports:
      - "8010:8080"
    environment:
      <<: *common-env
      ASPNETCORE_URLS: "http://+:8080"
      OTEL_SERVICE_NAME: cache-service
      ConnectionStrings__Redis: "go-nomads-redis:6379"
      services__city-service__http__0:      *svc-city
      services__coworking-service__http__0: *svc-coworking
    networks:
      - go-nomads-network
    restart: unless-stopped

  # ============================================================
  # Message Service
  # ============================================================
  message-service:
    image: swr.ap-southeast-3.myhuaweicloud.com/go-nomads/message-service:latest
    container_name: go-nomads-message-service
    ports:
      - "5005:8080"
    environment:
      <<: *common-env
      ASPNETCORE_URLS: "http://+:8080"
      OTEL_SERVICE_NAME: message-service
      ConnectionStrings__Redis: "go-nomads-redis:6379"
      RabbitMQ__Host: *rabbitmq-host
      RabbitMQ__Username: *rabbitmq-user
      RabbitMQ__Password: *rabbitmq-pass
      services__user-service__http__0: *svc-user
    networks:
      - go-nomads-network
    restart: unless-stopped

  # ============================================================
  # Accommodation Service
  # ============================================================
  accommodation-service:
    image: swr.ap-southeast-3.myhuaweicloud.com/go-nomads/accommodation-service:latest
    container_name: go-nomads-accommodation-service
    ports:
      - "8012:8080"
    environment:
      <<: *common-env
      ASPNETCORE_URLS: "http://+:8080"
      OTEL_SERVICE_NAME: accommodation-service
      services__user-service__http__0: *svc-user
    networks:
      - go-nomads-network
    restart: unless-stopped

  # ============================================================
  # Innovation Service
  # ============================================================
  innovation-service:
    image: swr.ap-southeast-3.myhuaweicloud.com/go-nomads/innovation-service:latest
    container_name: go-nomads-innovation-service
    ports:
      - "8011:8080"
    environment:
      <<: *common-env
      ASPNETCORE_URLS: "http://+:8080"
      OTEL_SERVICE_NAME: innovation-service
      RabbitMQ__Host: *rabbitmq-host
      RabbitMQ__Username: *rabbitmq-user
      RabbitMQ__Password: *rabbitmq-pass
      services__user-service__http__0: *svc-user
    networks:
      - go-nomads-network
    restart: unless-stopped

  # ============================================================
  # Search Service
  # ============================================================
  search-service:
    image: swr.ap-southeast-3.myhuaweicloud.com/go-nomads/search-service:latest
    container_name: go-nomads-search-service
    ports:
      - "8015:8080"
    environment:
      <<: *common-env
      ASPNETCORE_URLS: "http://+:8080"
      OTEL_SERVICE_NAME: search-service
      Elasticsearch__Url: *elasticsearch-url
      RabbitMQ__Host: *rabbitmq-host
      RabbitMQ__Username: *rabbitmq-user
      RabbitMQ__Password: *rabbitmq-pass
      services__city-service__http__0:      *svc-city
      services__coworking-service__http__0: *svc-coworking
    networks:
      - go-nomads-network
    restart: unless-stopped

  # ============================================================
  # Nginx Reverse Proxy
  # ============================================================
  nginx:
    image: nginx:alpine
    container_name: go-nomads-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deployment/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - gateway
    networks:
      - go-nomads-network
    restart: unless-stopped

networks:
  go-nomads-network:
    name: go-nomads-network
    external: true
