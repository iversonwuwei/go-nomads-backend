global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'go-nomads'
    environment: 'development'

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'

  - job_name: 'dapr-services'
    metrics_path: '/metrics'
    consul_sd_configs:
      - server: 'go-nomads-consul:8500'
        services: ['product-service', 'user-service', 'gateway']
        tags: ['dapr']
    relabel_configs:
      - source_labels: [__address__]
        regex: '([^:]+):.*'
        replacement: '${1}:9090'
        target_label: __address__
      - source_labels: [__meta_consul_service]
        target_label: app_id
      - replacement: 'dapr'
        target_label: service_type

  - job_name: 'app-services'
    metrics_path: '/metrics'
    consul_sd_configs:
      - server: 'go-nomads-consul:8500'
        services: ['product-service', 'user-service', 'gateway']
        tags: ['dapr']
    relabel_configs:
      - source_labels: [__address__]
        regex: '([^:]+):.*'
        replacement: '${1}:8080'
        target_label: __address__
      - source_labels: [__meta_consul_service]
        target_label: app
      - replacement: 'application'
        target_label: service_type

  - job_name: 'redis'
    static_configs:
      - targets: ['go-nomads-redis:6379']
        labels:
          service: 'redis'

  - job_name: 'zipkin'
    static_configs:
      - targets: ['go-nomads-zipkin:9411']
        labels:
          service: 'zipkin'
